<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>FutbolX - Live</title>
    <meta name="description" content="Watch PPV Live Stream and replays on demand">
    <meta name="keywords" content="futbolx, ppv, live stream, sports">
    <meta property="og:title" content="FutbolX - Live" />
    <meta property="og:image" content="/assets/img/og-image.jpg">
    <meta property="og:url" content="https://futbolx-nine.vercel.app/live" />
    <meta name="twitter:title" content="FutbolX - Live">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:description" content="Watch PPV Live Stream and replays on demand">
    <!-- Content Security Policy to block ad resources -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; frame-src 'self' https://example.com; script-src 'self'; img-src 'self' https://example.com; media-src 'self' https://example.com;">
    <link rel="preconnect" href="https://fonts.bunny.net" crossorigin>
    <link href="https://fonts.bunny.net/css?family=kanit:100,200,300,400,500,600,700,800,900" rel="stylesheet"> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.1/css/bootstrap.min.css" integrity="sha512-Z/def5z5u2aR89OuzYcxmDJ0Bnd5V1cKqBEbvLOiUNWdg9PQeXVvXLI90SE4QOHGlfLqUnDNVAYyZi8UwUTmWQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="/assets/css/main.css?v=24">
  </head>
  <body>
    <nav class="top-bar fixed-top">
      <div class="container-fluid">
        <button class="btn btn-dark" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebarMenu" aria-controls="sidebarMenu">
          <i class="fas fa-bars"></i>
        </button>
        <span class="futbolx-brand">FutbolX</span>
      </div>
    </nav>
    <div class="offcanvas offcanvas-start" tabindex="-1" id="sidebarMenu" aria-labelledby="sidebarMenuLabel">
      <div class="offcanvas-header">
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>
      <div class="offcanvas-body">
        <ul class="nav flex-column">
          <li class="nav-item"><a class="nav-link" href="/request">Request</a></li>
          <li class="nav-item"><a class="nav-link" href="/vods">VODs</a></li>
          <li class="nav-item"><a class="nav-link" href="https://discord.gg/CmRcPbBB2k">Discord</a></li>
          <li class="nav-item"><a class="nav-link" href="/vip">VIP</a></li>
          <li class="nav-item"><a class="nav-link" href="/auth/login" id="loginLink">Login</a></li>
          <li class="nav-item"><button class="nav-link btn btn-link d-none" id="logoutButton">Logout</button></li>
          <li class="nav-item">
            <button id="themeToggle" class="nav-link btn btn-link" aria-label="Toggle theme">
              <i class="fas fa-moon"></i>
            </button>
          </li>
        </ul>
      </div>
    </div>
    <div class="container-fluid main-content">
      <div class="container">
        <h1 id="eventTitle">Loading...</h1>
        <div class="video-container" id="playerContainer">
          <div id="player" style="width: 100%; height: 100%;"></div>
          <div id="playerError" class="alert alert-danger mt-3 d-none"></div>
          <div id="startLivestream" class="mt-3 text-center">
            <button class="btn btn-danger" id="startLivestreamBtn" disabled>Click to Start Livestream</button>
          </div>
          <div id="streamLinks" class="stream-links mt-3"></div>
        </div>
        <footer class="container-fluid d-flex flex-column flex-lg-row justify-content-lg-between align-items-center py-2 border-top mt-5">
          <p class="mb-2 mb-lg-0 text-body-secondary text-center text-lg-start">FutbolX 2025</p>
          <ul class="nav justify-content-center justify-content-lg-end mb-0">
            <li class="nav-item"><a href="/api" class="nav-link px-2 text-body-secondary">API</a></li>
            <li class="nav-item"><a href="https://discord.gg/CmRcPbBB2k" class="nav-link px-2 text-body-secondary">Discord</a></li>
            <li class="nav-item"><a href="/changelog" class="nav-link px-2 text-body-secondary">Changelog</a></li>
            <li class="nav-item"><a href="/vip" class="nav-link px-2 text-body-secondary">Donate / VIP Access</a></li>
            <li class="nav-item"><a href="/contact" class="nav-link px-2 text-body-secondary">Contact us</a></li>
          </ul>
        </footer>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm" crossorigin="anonymous"></script>
    <script src="/assets/js/api.js" async></script>
    <script src="/assets/js/auth.js" async></script>
    <script>
      let playerInstance = null;
      let streamData = null;
      const api = window.Api ? new Api('') : null;
      const playerContainer = document.getElementById('playerContainer');
      const playerError = document.getElementById('playerError');
      const startLivestreamBtn = document.getElementById('startLivestreamBtn');
      const streamLinks = document.getElementById('streamLinks');
      const uriName = window.location.pathname.split('/').pop();

      async function fetchWithRetry(url, retries = 3, delay = 1000) {
        for (let i = 0; i < retries; i++) {
          try {
            const response = api ? await api.get(url.replace(api.baseUrl, '')) : await fetch(url).then(res => res.json());
            return response;
          } catch (error) {
            console.warn(`Fetch attempt ${i + 1} failed for ${url}:`, error);
            if (i === retries - 1) throw error;
            await new Promise(resolve => setTimeout(resolve, delay));
          }
        }
      }

      function initPlayer(event, playerError, streamLinks) {
        try {
          // Select the first stream by default
          let currentStream = event.streams[0];
          const playerDiv = document.getElementById('player');
          
          // Render iframe with strict sandbox restrictions
          playerDiv.innerHTML = `
            <iframe
              src="${currentStream.url}"
              width="100%"
              height="100%"
              frameborder="0"
              allowfullscreen
              sandbox="allow-same-origin"
              allow="autoplay; fullscreen"
            ></iframe>
          `;
          
          // Attempt to filter ads (same-origin only)
          const iframe = playerDiv.querySelector('iframe');
          iframe.addEventListener('load', () => {
            try {
              const doc = iframe.contentDocument || iframe.contentWindow.document;
              const adElements = doc.querySelectorAll('[id*="ad"], [class*="ad"], [src*="ads"], [href*="ads"]');
              adElements.forEach(el => {
                el.style.display = 'none';
                console.log('Blocked ad element:', el);
              });
            } catch (err) {
              console.warn('Cannot access iframe content for ad filtering:', err);
            }
          });
          
          // Render stream buttons
          streamLinks.innerHTML = event.streams.map((stream, index) => `
            <button class="btn btn-stream ${index === 0 ? 'active' : ''}" data-stream-url="${stream.url}" data-stream-index="${index}" aria-label="Switch to ${stream.title || `Stream ${index + 1}`}">
              ${stream.title || `Stream ${index + 1}`}
            </button>
          `).join('');
          
          // Handle stream switching
          streamLinks.addEventListener('click', (e) => {
            const btn = e.target.closest('.btn.btn-stream');
            if (btn) {
              const url = btn.getAttribute('data-stream-url');
              playerError.className = 'alert alert-danger mt-3 d-none';
              try {
                console.log('Switching to stream:', url);
                playerDiv.innerHTML = `
                  <iframe
                    src="${url}"
                    width="100%"
                    height="100%"
                    frameborder="0"
                    allowfullscreen
                    sandbox="allow-same-origin"
                    allow="autoplay; fullscreen"
                  ></iframe>
                `;
                const newIframe = playerDiv.querySelector('iframe');
                newIframe.addEventListener('load', () => {
                  try {
                    const doc = newIframe.contentDocument || newIframe.contentWindow.document;
                    const adElements = doc.querySelectorAll('[id*="ad"], [class*="ad"], [src*="ads"], [href*="ads"]');
                    adElements.forEach(el => {
                      el.style.display = 'none';
                      console.log('Blocked ad element:', el);
                    });
                  } catch (err) {
                    console.warn('Cannot access iframe content for ad filtering:', err);
                  }
                });
                streamLinks.querySelectorAll('.btn.btn-stream').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
              } catch (err) {
                console.error('Stream switch error:', err);
                playerError.className = 'alert alert-danger mt-3';
                playerError.innerText = 'Failed to load stream: ' + (err.message || 'Unknown error');
              }
            }
          });
          
          playerContainer.classList.add('fade-in');
          streamLinks.classList.add('fade-in');
          startLivestreamBtn.style.display = 'none';
        } catch (err) {
          console.error('Player init error:', err);
          playerError.className = 'alert alert-danger mt-3';
          playerError.innerText = 'Failed to initialize stream: ' + (err.message || 'Unknown error');
        }
      }

      function initPage() {
        try {
          console.log('Initializing page at', new Date().toISOString());
          const htmlElement = document.documentElement;
          const themeToggle = document.getElementById('themeToggle');
          const currentTheme = localStorage.getItem('theme') || 'dark';
          htmlElement.setAttribute('data-bs-theme', currentTheme);
          themeToggle.innerHTML = currentTheme === 'dark' ? '<i class="fas fa-moon"></i>' : '<i class="fas fa-sun"></i>';
          
          themeToggle.addEventListener('click', () => {
            const newTheme = htmlElement.getAttribute('data-bs-theme') === 'dark' ? 'light' : 'dark';
            htmlElement.setAttribute('data-bs-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            themeToggle.innerHTML = newTheme === 'dark' ? '<i class="fas fa-moon"></i>' : '<i class="fas fa-sun"></i>';
          });

          const offcanvasElement = document.getElementById('sidebarMenu');
          document.addEventListener('click', (event) => {
            const toggler = document.querySelector('[data-bs-toggle="offcanvas"]');
            const isOffcanvasOpen = offcanvasElement.classList.contains('show');
            const clickedInside = offcanvasElement.contains(event.target) || toggler.contains(event.target);
            if (isOffcanvasOpen && !clickedInside) {
              bootstrap.Offcanvas.getOrCreateInstance(offcanvasElement).hide();
            }
          });

          startLivestreamBtn.addEventListener('click', () => {
            if (streamData) {
              playerContainer.classList.add('fade-in');
              streamLinks.classList.add('fade-in');
              startLivestreamBtn.style.display = 'none';
              initPlayer(streamData, playerError, streamLinks);
            }
          });

          fetchWithRetry(api?.baseUrl + '/stream' || '/api/stream')
            .then(data => {
              if (!data || !data.success || !Array.isArray(data.streams)) {
                document.getElementById('eventTitle').innerText = 'Error: Stream not found';
                playerError.className = 'alert alert-danger mt-3';
                playerError.innerText = 'No streams available.';
                startLivestreamBtn.disabled = true;
                startLivestreamBtn.innerText = 'Stream Unavailable';
                return;
              }
              let event = null;
              for (const category of data.streams) {
                if (category.streams) {
                  event = category.streams.find(stream => stream.uri_name === uriName);
                  if (event) break;
                }
              }
              if (!event || !event.streams || event.streams.length === 0) {
                document.getElementById('eventTitle').innerText = 'Error: No streams available';
                playerError.className = 'alert alert-danger mt-3';
                playerError.innerText = 'No stream links found for this event.';
                startLivestreamBtn.disabled = true;
                startLivestreamBtn.innerText = 'No Streams';
                return;
              }
              document.getElementById('eventTitle').innerText = event.name;
              streamData = event;
              const now = Math.floor(Date.now() / 1000);
              const startTime = new Date(event.starts_at).getTime() / 1000;
              const endTime = event.ends_at ? new Date(event.ends_at).getTime() / 1000 : startTime + 3 * 3600;
              const isLive = (startTime <= now && now <= endTime) || event.always_live === 1;
              startLivestreamBtn.disabled = false;
              startLivestreamBtn.innerText = isLive ? 'Watch Now' : 'Stream Not Live Yet';
              if (isLive) {
                playerContainer.classList.add('fade-in');
                streamLinks.classList.add('fade-in');
                startLivestreamBtn.style.display = 'none';
                initPlayer(streamData, playerError, streamLinks);
              }
            })
            .catch(error => {
              console.error('Stream fetch error:', error);
              document.getElementById('eventTitle').innerText = 'Error: Failed to load stream';
              playerError.className = 'alert alert-danger mt-3';
              playerError.innerText = 'Failed to fetch stream data. Please check your connection.';
              startLivestreamBtn.disabled = true;
              startLivestreamBtn.innerText = 'Fetch Failed';
            });

          checkAuthStatus();
          console.log('Page initialized successfully');
        } catch (error) {
          console.error('Init page error:', error);
        }
      }

      document.addEventListener('DOMContentLoaded', () => {
        console.log('DOM loaded at', new Date().toISOString());
        initPage();
      });
    </script>
  </body>
</html>
