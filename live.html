<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>FutbolX - Watch Live</title>
  <meta name="description" content="Watch live PPV boxing, UFC, Basketball, Football, and more on FutbolX.">
  <meta name="keywords" content="futbolx, ppv, free ppv, boxing, ufc, basketball, football, stream, online, free">
  <meta property="og:title" content="FutbolX - Watch Live" />
  <meta property="og:url" content="https://your-futbolx-site.vercel.app/live" />
  <meta property="og:image" content="/assets/img/og-image.jpg">
  <meta name="twitter:title" content="FutbolX - Watch Live">
  <meta name="twitter:description" content="Watch live PPV boxing and other content on FutbolX.">
  <meta name="twitter:card" content="summary_large_image">
  <link rel="preconnect" href="https://fonts.bunny.net" crossorigin="anonymous">
  <link href="https://fonts.bunny.net/css?family=kanit:100,200,300,400,500,600,700,800,900" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.1/css/bootstrap.min.css" integrity="sha512-Z/def5z5u2aR89OuzYcxmDJ0Bnd5V1cKqBEbvLOiUNWdg9PQeXVvXLI90SE4QOHGlfLqUnDNVAYyZi8UwUTmWQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="/assets/css/main.css?v=24">
</head>
<body>
  <!-- Top Bar -->
  <nav class="top-bar fixed-top">
    <div class="container-fluid">
      <button class="btn btn-dark" type="button" id="sidebarToggler" data-bs-toggle="offcanvas" data-bs-target="#sidebarMenu" aria-controls="sidebarMenu">
        <i class="fas fa-bars"></i>
      </button>
      <span class="futbolx-brand">FutbolX</span>
    </div>
  </nav>
  <!-- Left Sidebar -->
  <div class="offcanvas offcanvas-start" tabindex="-1" id="sidebarMenu" aria-labelledby="sidebarMenuLabel">
    <div class="offcanvas-header">
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
      <ul class="nav flex-column">
        <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
        <li class="nav-item"><a class="nav-link" href="/request">Request</a></li>
        <li class="nav-item"><a class="nav-link" href="/vods">VODs</a></li>
        <li class="nav-item"><a class="nav-link" href="https://discord.gg/CmRcPbBB2k">Discord</a></li>
        <li class="nav-item"><a class="nav-link" href="/vip">VIP</a></li>
        <li class="nav-item"><a class="nav-link" href="/auth/login" id="loginLink">Login</a></li>
        <li class="nav-item"><button class="nav-link btn btn-link d-none" id="logoutButton">Logout</button></li>
        <li class="nav-item">
          <button id="themeToggle" class="nav-link btn btn-link" aria-label="Toggle theme">
            <i class="fas fa-moon"></i>
          </button>
        </li>
      </ul>
    </div>
  </div>
  <!-- Main Content -->
  <div class="container-fluid main-content">
    <div class="container">
      <a href="/" class="btn btn-back mt-3"><i class="fas fa-arrow-left"></i> Back to Home</a>
      <h1 id="eventTitle" class="mt-3">Loading...</h1>
      <div class="tip-container mt-3">
        <div class="alert alert-info fade-in">
          <strong>Tip:</strong> For the best experience, use a supported browser like Chrome or Firefox. This message will disappear in <span id="countdownTimer">10s</span>.
        </div>
      </div>
      <div id="errorContainer" class="d-none error-alert mt-3"></div>
      <div class="video-container mt-3 d-none">
        <iframe id="embedPlayer" title="Live Stream" allow="autoplay; encrypted-media" allowfullscreen></iframe>
      </div>
      <div class="stream-links mt-3 d-none" id="streamLinks"></div>
      <button id="startLivestream" class="btn btn-danger mt-3">Loading...</button>
      <button id="fullscreenBtn" class="btn btn-danger mt-3 ms-2 d-none"><i class="fas fa-expand"></i> Fullscreen</button>
    </div>
  </div>
  <script src="/_vercel/insights/script.js" defer></script>
  <script src="/_vercel/speed-insights/script.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm" crossorigin="anonymous"></script>
  <script src="/assets/js/api.js"></script>
  <script async src="/assets/js/auth.js"></script>
  <script defer data-domain="your-futbolx-site.vercel.app" src="https://p.vidembed.re/js/script.js"></script>
  <script>
    window.plausible = window.plausible || function() { (window.plausible.q = window.plausible.q || []).push(arguments) };

    let embedPlayer = null;
    let streamData = null;

    // Block popups
    const originalOpen = window.open;
    window.open = function(url) {
      console.log('Blocked popup attempt to:', url);
      return null;
    };

    function clearError() {
      const errorContainer = document.getElementById('errorContainer');
      if (errorContainer && !errorContainer.classList.contains('d-none')) {
        errorContainer.classList.add('fade-out');
        setTimeout(() => {
          errorContainer.className = 'd-none error-alert';
          errorContainer.innerHTML = '';
        }, 500);
      }
    }

    function countdownTip() {
      const countdownTimer = document.getElementById('countdownTimer');
      const tipContainer = document.querySelector('.tip-container');
      if (!countdownTimer || !tipContainer) return;
      
      let timeLeft = parseInt(countdownTimer.textContent);
      const interval = setInterval(() => {
        timeLeft -= 1;
        countdownTimer.textContent = `${timeLeft}s`;
        if (timeLeft <= 0) {
          clearInterval(interval);
          tipContainer.classList.add('fade-out');
          setTimeout(() => {
            tipContainer.style.display = 'none';
          }, 500);
        }
      }, 1000);
    }

    function fetchWithRetry(url, maxRetries = 3, delay = 1000) {
      return new Promise((resolve, reject) => {
        let attempts = 0;
        function attempt() {
          attempts++;
          console.log(`Fetching ${url}, attempt ${attempts}`);
          fetch(url, { signal: AbortSignal.timeout(5000) })
            .then(res => {
              console.log(`Fetch status: ${res.status} ${res.statusText}`);
              if (!res.ok) {
                return res.text().then(text => {
                  throw new Error(`HTTP error ${res.status}: ${res.statusText} - ${text}`);
                });
              }
              return res.json();
            })
            .then(data => {
              clearError();
              resolve(data);
            })
            .catch(error => {
              console.error(`Fetch attempt ${attempts} failed:`, error);
              if (attempts < maxRetries) {
                setTimeout(attempt, delay);
              } else {
                reject(error);
              }
            });
        }
        attempt();
      });
    }

    function loadStream(api, uriName) {
      console.log('Loading stream for URI:', uriName);
      const eventTitle = document.getElementById('eventTitle');
      const startLivestream = document.getElementById('startLivestream');
      const videoContainer = document.querySelector('.video-container');
      const streamLinks = document.getElementById('streamLinks');
      const errorContainer = document.getElementById('errorContainer');
      const fullscreenBtn = document.getElementById('fullscreenBtn');

      eventTitle.textContent = 'Loading...';
      startLivestream.textContent = 'Loading...';
      startLivestream.disabled = true;
      videoContainer.classList.add('d-none');
      streamLinks.classList.add('d-none');
      fullscreenBtn.classList.add('d-none');

      const apiUrl = api.baseUrl.endsWith('/') ? `${api.baseUrl}stream` : `${api.baseUrl}/stream`;
      const api247Url = api.baseUrl.endsWith('/') ? `${api.baseUrl}stream247` : `${api.baseUrl}/stream247`;

      // Fetch both regular and 24/7 streams
      const regularStreamsPromise = fetchWithRetry(apiUrl)
        .then(streamData => {
          if (!streamData || !streamData.success || !Array.isArray(streamData.streams)) {
            console.warn('Invalid stream data received:', streamData);
            return { success: false, streams: [] };
          }
          return streamData;
        })
        .catch(error => {
          console.error('Regular streams fetch error:', error.message);
          return { success: false, streams: [] };
        });

      const live247StreamsPromise = fetchWithRetry(api247Url)
        .then(stream247Data => {
          if (!stream247Data || !stream247Data.success || !Array.isArray(stream247Data.streams)) {
            console.warn('Invalid 24/7 stream data received:', stream247Data);
            return { success: false, streams: [] };
          }
          return stream247Data;
        })
        .catch(error => {
          console.error('24/7 streams fetch error:', error.message);
          return { success: false, streams: [] };
        });

      Promise.all([regularStreamsPromise, live247StreamsPromise])
        .then(([streamData, stream247Data]) => {
          console.log('Stream API Response:', streamData);
          console.log('24/7 Stream API Response:', stream247Data);

          let foundStream = null;
          const now = Math.floor(Date.now() / 1000);

          // Check regular streams
          if (streamData.success && Array.isArray(streamData.streams)) {
            for (const category of streamData.streams) {
              if (!category.streams || !Array.isArray(category.streams)) continue;
              const stream = category.streams.find(s => s.uri_name === uriName);
              if (stream) {
                foundStream = stream;
                foundStream.category = category.category;
                break;
              }
            }
          }

          // Check 24/7 streams
          if (!foundStream && stream247Data.success && Array.isArray(stream247Data.streams)) {
            for (const category of stream247Data.streams) {
              if (!category.streams || !Array.isArray(category.streams)) continue;
              const stream = category.streams.find(s => s.uri_name === uriName);
              if (stream) {
                foundStream = stream;
                foundStream.category = category.category;
                break;
              }
            }
          }

          if (!foundStream || !foundStream.streams || !Array.isArray(foundStream.streams) || foundStream.streams.length === 0) {
            eventTitle.textContent = 'Stream Not Found';
            startLivestream.textContent = 'Stream Unavailable';
            startLivestream.disabled = true;
            errorContainer.className = 'alert alert-danger error-alert';
            errorContainer.innerHTML = 'The requested stream could not be found or has no available sources.';
            return;
          }

          streamData = foundStream;
          eventTitle.textContent = streamData.name || 'Live Stream';
          document.title = `FutbolX - ${streamData.name || 'Watch Live'}`;
          startLivestream.textContent = 'Start Livestream';
          startLivestream.disabled = false;

          streamLinks.innerHTML = '';
          streamData.streams.forEach((stream, index) => {
            const btn = document.createElement('button');
            btn.className = 'btn btn-stream';
            btn.textContent = stream.title || `Stream ${index + 1}`;
            btn.dataset.url = stream.url;
            btn.addEventListener('click', () => {
              document.querySelectorAll('.btn-stream').forEach(b => b.classList.remove('active'));
              btn.classList.add('active');
              embedPlayer.src = stream.url;
              videoContainer.classList.remove('d-none');
              fullscreenBtn.classList.remove('d-none');
              window.plausible('StreamPlay', { props: { stream: streamData.name, url: stream.url } });
            });
            streamLinks.appendChild(btn);
          });

          streamLinks.classList.remove('d-none');
          startLivestream.addEventListener('click', () => {
            const firstStream = streamData.streams[0];
            if (firstStream && firstStream.url) {
              embedPlayer.src = firstStream.url;
              videoContainer.classList.remove('d-none');
              streamLinks.querySelector('.btn-stream').classList.add('active');
              fullscreenBtn.classList.remove('d-none');
              startLivestream.classList.add('d-none');
              window.plausible('StreamPlay', { props: { stream: streamData.name, url: firstStream.url } });
            }
          });

          // Auto-start 24/7 streams
          if (streamData.always_live === 1) {
            const firstStream = streamData.streams[0];
            if (firstStream && firstStream.url) {
              embedPlayer.src = firstStream.url;
              videoContainer.classList.remove('d-none');
              streamLinks.querySelector('.btn-stream').classList.add('active');
              fullscreenBtn.classList.remove('d-none');
              startLivestream.classList.add('d-none');
              window.plausible('StreamPlay', { props: { stream: streamData.name, url: firstStream.url } });
            }
          }
        })
        .catch(error => {
          console.error('API Fetch Error:', error.message);
          eventTitle.textContent = 'Error Loading Stream';
          startLivestream.textContent = 'Retry';
          startLivestream.disabled = false;
          errorContainer.className = 'alert alert-danger error-alert';
          errorContainer.innerHTML = `Failed to load stream: ${error.message}. Please try again.`;
          startLivestream.addEventListener('click', () => loadStream(api, uriName));
        });
    }

    function initOffcanvas() {
      const offcanvasElement = document.getElementById('sidebarMenu');
      const toggler = document.getElementById('sidebarToggler');
      
      if (!offcanvasElement || !toggler) {
        console.error('Offcanvas or toggler not found');
        return;
      }

      console.log('Initializing offcanvas');
      if (typeof bootstrap === 'undefined') {
        console.warn('Bootstrap not loaded. Relying on data attributes.');
        return;
      }

      try {
        const offcanvas = new bootstrap.Offcanvas(offcanvasElement);
        offcanvasElement.addEventListener('hidden.bs.offcanvas', () => {
          console.log('Offcanvas closed');
        });

        const navLinks = offcanvasElement.querySelectorAll('.nav-link');
        navLinks.forEach(link => {
          link.addEventListener('click', (event) => {
            event.stopPropagation();
            const href = link.getAttribute('href');
            if (href) {
              console.log('Nav link clicked:', href);
              window.location.href = href;
            }
          });
        });

        const logoutButton = document.getElementById('logoutButton');
        if (logoutButton) {
          logoutButton.addEventListener('click', (event) => {
            event.stopPropagation();
            console.log('Logout button clicked');
          });
        }

        const themeToggle = document.getElementById('themeToggle');
        if (themeToggle) {
          themeToggle.addEventListener('click', (event) => {
            event.stopPropagation();
          });
        }
      } catch (error) {
        console.error('Offcanvas initialization error:', error);
      }
    }

    function initPage() {
      console.log('Initializing page at', new Date().toISOString());
      const htmlElement = document.documentElement;
      const themeToggle = document.getElementById('themeToggle');
      const currentTheme = localStorage.getItem('theme') || 'dark';
      htmlElement.setAttribute('data-bs-theme', currentTheme);
      themeToggle.innerHTML = currentTheme === 'dark' ? '<i class="fas fa-moon"></i>' : '<i class="fas fa-sun"></i>';

      themeToggle.addEventListener('click', () => {
        const newTheme = htmlElement.getAttribute('data-bs-theme') === 'dark' ? 'light' : 'dark';
        htmlElement.setAttribute('data-bs-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        themeToggle.innerHTML = newTheme === 'dark' ? '<i class="fas fa-moon"></i>' : '<i class="fas fa-sun"></i>';
      });

      embedPlayer = document.getElementById('embedPlayer');
      const uriName = window.location.pathname.split('/').pop();

      try {
        if (typeof Api === 'undefined') {
          console.warn('Api class not defined. Using default API path.');
          loadStream({ baseUrl: window.location.origin + '/api' }, uriName);
        } else {
          const api = new Api(`${window.location.origin}/api`);
          loadStream(api, uriName);
        }
      } catch (error) {
        console.error('API initialization error:', error);
        document.getElementById('eventTitle').textContent = 'Error Loading Stream';
        document.getElementById('startLivestream').textContent = 'Retry';
        document.getElementById('startLivestream').disabled = false;
        document.getElementById('errorContainer').className = 'alert alert-danger error-alert';
        document.getElementById('errorContainer').innerHTML = 'Failed to initialize stream. Please try again.';
        document.getElementById('startLivestream').addEventListener('click', () => window.location.reload());
      }

      const fullscreenBtn = document.getElementById('fullscreenBtn');
      fullscreenBtn.addEventListener('click', () => {
        if (embedPlayer.requestFullscreen) {
          embedPlayer.requestFullscreen();
        } else if (embedPlayer.webkitRequestFullscreen) {
          embedPlayer.webkitRequestFullscreen();
        } else if (embedPlayer.msRequestFullscreen) {
          embedPlayer.msRequestFullscreen();
        }
      });

      try {
        checkAuthStatus();
      } catch (error) {
        console.warn('Auth status check failed:', error);
      }

      initOffcanvas();
      countdownTip();
      console.log('Page initialized successfully');
    }

    document.addEventListener('DOMContentLoaded', () => {
      console.log('DOM loaded at', new Date().toISOString());
      initPage();
    });
  </script>
</body>
</html>
