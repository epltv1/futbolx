<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>FutbolX - Watch Live</title>
    <meta name="description" content="FutbolX - Watch live PPV boxing, UFC, Basketball, Football, and more.">
    <meta name="keywords" content="futbolx, ppv, free ppv, boxing, ufc, basketball, football, stream, online, free">
    <meta property="og:title" content="FutbolX - Watch Live" />
    <meta property="og:url" content="https://your-futbolx-site.vercel.app/live" />
    <meta property="og:image" content="/assets/img/og-image.jpg">
    <meta name="twitter:title" content="FutbolX - Watch Live">
    <meta name="twitter:description" content="Watch live PPV boxing and other content on FutbolX.">
    <meta name="twitter:card" content="summary_large_image">
    <link rel="preconnect" href="https://fonts.bunny.net" crossorigin>
    <link href="https://fonts.bunny.net/css?family=kanit:100,200,300,400,500,600,700,800,900" rel="stylesheet"> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.1/css/bootstrap.min.css" integrity="sha512-Z/def5z5u2aR89OuzYcxmDJ0Bnd5V1cKqBEbvLOiUNWdg9PQeXVvXLI90SE4QOHGlfLqUnDNVAYyZi8UwUTmWQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="/assets/css/main.css?v=24">
    <style>
      .alert-info { 
        max-width: 600px; 
        margin: 20px auto; 
        text-align: center; 
        position: relative; 
        padding-right: 50px; /* Space for timer */
      }
      #countdownTimer { 
        position: absolute; 
        top: 8px; 
        right: 10px; 
        font-weight: bold; 
        color: #ff4d4d; 
      }
      [data-bs-theme="light"] #countdownTimer { 
        color: #e63939; 
      }
      .fade-out { 
        animation: fadeOut 0.5s ease-out forwards; 
      }
      @keyframes fadeOut { 
        from { opacity: 1; } 
        to { opacity: 0; visibility: hidden; } 
      }
    </style>
  </head>
  <body>
    <!-- Top Bar -->
    <nav class="top-bar fixed-top">
      <div class="container-fluid">
        <button class="btn btn-dark" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebarMenu" aria-controls="sidebarMenu">
          <i class="fas fa-bars"></i>
        </button>
        <span class="futbolx-brand">FutbolX</span>
      </div>
    </nav>
    <!-- Left Sidebar -->
    <div class="offcanvas offcanvas-start" tabindex="-1" id="sidebarMenu" aria-labelledby="sidebarMenuLabel">
      <div class="offcanvas-header">
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>
      <div class="offcanvas-body">
        <ul class="nav flex-column">
          <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
          <li class="nav-item"><a class="nav-link" href="/request">Request</a></li>
          <li class="nav-item"><a class="nav-link" href="/vods">VODs</a></li>
          <li class="nav-item"><a class="nav-link" href="https://discord.gg/CmRcPbBB2k">Discord</a></li>
          <li class="nav-item"><a class="nav-link" href="/vip">VIP</a></li>
          <li class="nav-item"><a class="nav-link" href="/auth/login" id="loginLink">Login</a></li>
          <li class="nav-item"><button class="nav-link btn btn-link d-none" id="logoutButton">Logout</button></li>
          <li class="nav-item">
            <button id="themeToggle" class="nav-link btn btn-link" aria-label="Toggle theme">
              <i class="fas fa-moon"></i>
            </button>
          </li>
        </ul>
      </div>
    </div>
    <!-- Main Content -->
    <div class="container-fluid main-content">
      <div class="container mt-4">
        <div class="row">
          <div class="col-12">
            <div class="alert alert-info">
              <strong>Tip:</strong> For an ad-free experience, consider installing an ad blocker like 
              <a href="https://ublockorigin.com" target="_blank" rel="noopener">uBlock Origin</a> or 
              <a href="https://adguard.com" target="_blank" rel="noopener">AdGuard</a>.
              <span id="countdownTimer">5s</span>
            </div>
            <div class="d-flex align-items-center mb-3">
              <a href="/" class="btn btn-back"><i class="fas fa-arrow-left"></i> Back to Home</a>
              <button id="startLivestream" class="btn btn-danger ms-3" disabled>Loading...</button>
            </div>
            <h2 id="eventTitle" class="mb-3"></h2>
            <div class="video-container">
              <iframe id="embedPlayer" frameborder="0" allowfullscreen style="width: 100%; height: 100%;" allow="autoplay; fullscreen" sandbox="allow-scripts allow-same-origin allow-presentation"></iframe>
            </div>
            <div id="streamLinks" class="stream-links mt-3"></div>
            <div id="playerError" class="alert alert-danger mt-3 d-none"></div>
          </div>
        </div>
        <footer class="container-fluid d-flex flex-column flex-lg-row justify-content-lg-between align-items-center py-2 border-top mt-5">
          <p class="mb-2 mb-lg-0 text-body-secondary text-center text-lg-start">FutbolX 2025</p>
          <ul class="nav justify-content-center justify-content-lg-end mb-0">
            <li class="nav-item"><a href="/api" class="nav-link px-2 text-body-secondary">API</a></li>
            <li class="nav-item"><a href="https://discord.gg/CmRcPbBB2k" class="nav-link px-2 text-body-secondary">Discord</a></li>
            <li class="nav-item"><a href="/changelog" class="nav-link px-2 text-body-secondary">Changelog</a></li>
            <li class="nav-item"><a href="/vip" class="nav-link px-2 text-body-secondary">Donate / VIP Access</a></li>
            <li class="nav-item"><a href="/contact" class="nav-link px-2 text-body-secondary">Contact us</a></li>
          </ul>
        </footer>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm" crossorigin="anonymous"></script>
    <script src="/assets/js/api.js"></script>
    <script async src="/assets/js/auth.js"></script>
    <script>
      let embedPlayer = null;
      let streamData = null;

      // Block popups via window.open override
      const originalOpen = window.open;
      window.open = function(url) {
        console.log('Blocked popup attempt to:', url);
        return null; // Prevent popups
      };

      // Auto-hide tip message with fade-out animation
      function startTipCountdown() {
        const tipAlert = document.querySelector('.alert-info');
        const countdownTimer = document.getElementById('countdownTimer');
        let seconds = 5;

        if (!tipAlert || !countdownTimer) {
          console.warn('Tip alert or countdown timer not found');
          return;
        }

        const interval = setInterval(() => {
          seconds--;
          countdownTimer.textContent = `${seconds}s`;
          if (seconds <= 0) {
            clearInterval(interval);
            tipAlert.classList.add('fade-out');
            console.log('Tip message fading out');
          }
        }, 1000);

        // Ensure tip is hidden after fade-out animation
        setTimeout(() => {
          tipAlert.style.visibility = 'hidden';
          clearInterval(interval);
        }, 5500); // 5s + 0.5s animation
      }

      // Initialize offcanvas explicitly
      function initOffcanvas() {
        const offcanvasElement = document.getElementById('sidebarMenu');
        const toggler = document.querySelector('[data-bs-toggle="offcanvas"]');
        
        if (!offcanvasElement || !toggler) {
          console.error('Offcanvas or toggler not found');
          return;
        }

        console.log('Initializing offcanvas');
        if (typeof bootstrap === 'undefined') {
          console.error('Bootstrap not loaded');
          return;
        }

        const offcanvas = new bootstrap.Offcanvas(offcanvasElement);
        toggler.addEventListener('click', () => {
          console.log('Toggler clicked');
          offcanvas.toggle();
        });

        // Close offcanvas on outside click
        document.addEventListener('click', (event) => {
          const isOffcanvasOpen = offcanvasElement.classList.contains('show');
          const clickedInside = offcanvasElement.contains(event.target) || toggler.contains(event.target);
          if (isOffcanvasOpen && !clickedInside) {
            console.log('Closing offcanvas due to outside click');
            offcanvas.hide();
          }
        });
      }

      function initPlayer(event, playerError, streamLinks) {
        console.log('initPlayer called');
        try {
          embedPlayer = document.getElementById('embedPlayer');
          console.log('Loading embed URL:', event.streams[0].url);
          embedPlayer.src = event.streams[0].url; // Load initial embed URL
          console.log('Embed initialized successfully');

          // Generate stream buttons
          streamLinks.innerHTML = event.streams.map((stream, index) => `
            <button class="btn btn-stream ${index === 0 ? 'active' : ''}" data-stream-url="${stream.url}" data-stream-index="${index}">
              ${stream.title || `Stream ${index + 1}`}
            </button>
          `).join('');

          // Stream switching
          streamLinks.addEventListener('click', (e) => {
            const btn = e.target.closest('.btn.btn-stream');
            if (btn) {
              const url = btn.getAttribute('data-stream-url');
              playerError.className = 'alert alert-danger mt-3 d-none';
              try {
                console.log('Switching to embed URL:', url);
                embedPlayer.src = url;
                streamLinks.querySelectorAll('.btn.btn-stream').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                console.log('Embed switched successfully');
              } catch (err) {
                console.error('Embed switch error:', err);
                playerError.className = 'alert alert-danger mt-3';
                playerError.innerText = 'Failed to switch stream: ' + (err.message || 'Unknown error');
              }
            }
          });

          // Iframe error handling
          embedPlayer.onerror = () => {
            console.error('Embed load error');
            playerError.className = 'alert alert-danger mt-3';
            playerError.innerText = 'Failed to load stream. The embed URL may be invalid or restricted.';
          };
        } catch (err) {
          console.error('Embed init error:', err);
          playerError.className = 'alert alert-danger mt-3';
          playerError.innerText = 'Failed to initialize stream: ' + (err.message || 'Unknown error');
        }
      }

      function fetchWithRetry(url, maxRetries = 3, delay = 1000) {
        return new Promise((resolve, reject) => {
          let attempts = 0;
          function attempt() {
            attempts++;
            console.log(`Fetching ${url}, attempt ${attempts}`);
            fetch(url)
              .then(res => {
                console.log(`Fetch status: ${res.status}`);
                if (!res.ok) throw new Error(`HTTP error ${res.status}`);
                return res.json();
              })
              .then(data => resolve(data))
              .catch(error => {
                console.error(`Fetch attempt ${attempts} failed:`, error);
                if (attempts < maxRetries) {
                  setTimeout(attempt, delay);
                } else {
                  reject(error);
                }
              });
          }
          attempt();
        });
      }

      function initPage() {
        console.log('Initializing page at', new Date().toISOString());
        const playerError = document.getElementById('playerError');
        const startLivestreamBtn = document.getElementById('startLivestream');
        const eventTitle = document.getElementById('eventTitle');

        try {
          // Initialize theme
          const htmlElement = document.documentElement;
          const themeToggle = document.getElementById('themeToggle');
          const currentTheme = localStorage.getItem('theme') || 'dark';
          htmlElement.setAttribute('data-bs-theme', currentTheme);
          themeToggle.innerHTML = currentTheme === 'dark' ? '<i class="fas fa-moon"></i>' : '<i class="fas fa-sun"></i>';

          themeToggle.addEventListener('click', () => {
            const newTheme = htmlElement.getAttribute('data-bs-theme') === 'dark' ? 'light' : 'dark';
            htmlElement.setAttribute('data-bs-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            themeToggle.innerHTML = newTheme === 'dark' ? '<i class="fas fa-moon"></i>' : '<i class="fas fa-sun"></i>';
          });

          // Load stream data
          const uriName = window.location.pathname.split('/').pop();
          const playerContainer = document.querySelector('.video-container');
          const streamLinks = document.getElementById('streamLinks');

          if (typeof Api === 'undefined') {
            console.error('Api class not defined. Ensure api.js is loaded.');
            eventTitle.innerText = 'Error: Failed to initialize';
            playerError.className = 'alert alert-danger mt-3';
            playerError.innerText = 'API initialization failed. Please refresh.';
            startLivestreamBtn.disabled = true;
            startLivestreamBtn.innerText = 'Error';
            return;
          }

          const api = new Api(`${window.location.origin}/api`);
          fetchWithRetry(api.baseUrl + '/stream')
            .then(data => {
              console.log('Stream API Response:', data);
              if (!data || !data.success || !Array.isArray(data.streams)) {
                throw new Error('Invalid stream data');
              }
              let event = null;
              for (const category of data.streams) {
                if (category.streams && Array.isArray(category.streams)) {
                  event = category.streams.find(stream => stream.uri_name === uriName);
                  if (event) break;
                }
              }
              if (!event || !event.streams || !Array.isArray(event.streams) || event.streams.length === 0) {
                throw new Error('No stream links found for this event');
              }
              // Validate event data
              if (!event.name || !event.starts_at) {
                throw new Error('Missing required event fields');
              }
              // Check if event is live
              const now = Math.floor(Date.now() / 1000);
              const eatOffsetSeconds = 10800; // 3 hours
              let startTime, endTime;
              try {
                startTime = new Date(event.starts_at + '+03:00').getTime() / 1000;
                if (isNaN(startTime)) {
                  console.warn(`Invalid start time for event ${event.name}`);
                  startTime = now;
                }
                endTime = event.ends_at 
                  ? new Date(event.ends_at + '+03:00').getTime() / 1000 
                  : startTime + 3 * 3600;
                if (isNaN(endTime)) {
                  console.warn(`Invalid end time for event ${event.name}`);
                  endTime = startTime + 3 * 3600;
                }
              } catch (e) {
                console.warn(`Error parsing time for event ${event.name}: ${e.message}`);
                startTime = now;
                endTime = now + 3 * 3600;
              }
              const isLive = (startTime <= now && now <= endTime) || event.always_live === 1;
              if (!isLive) {
                eventTitle.innerText = event.name + ' (Not Live)';
                playerError.className = 'alert alert-danger mt-3';
                playerError.innerText = 'This event is not currently live.';
                startLivestreamBtn.disabled = true;
                startLivestreamBtn.innerText = 'Event Not Live';
                return;
              }
              eventTitle.innerText = event.name;
              streamData = event;
              startLivestreamBtn.disabled = false;
              startLivestreamBtn.innerText = 'Click to Start Livestream';
              console.log('Stream data loaded:', event);

              startLivestreamBtn.addEventListener('click', () => {
                console.log('Start Livestream button clicked, streamData:', streamData);
                if (streamData) {
                  playerContainer.classList.add('fade-in');
                  streamLinks.classList.add('fade-in');
                  startLivestreamBtn.style.display = 'none';
                  initPlayer(streamData, playerError, streamLinks);
                  console.log('Embed player and stream links displayed');
                } else {
                  console.warn('No stream data available');
                  playerError.className = 'alert alert-danger mt-3';
                  playerError.innerText = 'Stream data not loaded. Please refresh the page.';
                }
              });
            })
            .catch(error => {
              console.error('Stream fetch error:', error);
              eventTitle.innerText = 'Error: Failed to load stream';
              playerError.className = 'alert alert-danger mt-3';
              playerError.innerText = 'Failed to fetch stream data. Please check your connection or refresh.';
              startLivestreamBtn.disabled = true;
              startLivestreamBtn.innerText = 'Fetch Failed';
            });

          checkAuthStatus();
          console.log('Page initialized successfully');
        } catch (error) {
          console.error('Init page error:', error);
          eventTitle.innerText = 'Error: Failed to initialize page';
          playerError.className = 'alert alert-danger mt-3';
          playerError.innerText = 'An error occurred. Please refresh the page.';
          startLivestreamBtn.disabled = true;
          startLivestreamBtn.innerText = 'Error';
        }
      }

      document.addEventListener('DOMContentLoaded', () => {
        console.log('DOM loaded at', new Date().toISOString());
        initOffcanvas(); // Initialize offcanvas
        startTipCountdown(); // Start tip message countdown
        initPage();
      });

      document.addEventListener('click', (event) => {
        const link = event.target.closest('a[href]');
        if (link) {
          const href = link.getAttribute('href');
          if (href.startsWith('/vip') || href.startsWith('https://') || href === '/auth/login' || href === '/request' || href === '/vods') {
            return;
          }
          if (href.startsWith('/')) {
            event.preventDefault();
            console.log('Navigating to:', href);
            window.location.href = href;
          }
        }
      });
    </script>
  </body>
</html>
