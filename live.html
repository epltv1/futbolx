<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>FutbolX - Live Stream</title>
    <meta name="description" content="FutbolX - Watch live PPV boxing, UFC, Basketball, Football, and more in high quality.">
    <meta name="keywords" content="futbolx, ppv, live stream, boxing, ufc, basketball, football, stream, online">
    <meta property="og:title" content="FutbolX - Live Stream" />
    <meta property="og:url" content="https://your-futbolx-site.vercel.app/live" />
    <meta property="og:image" content="/assets/img/og-image.jpg">
    <meta name="twitter:title" content="FutbolX - Live Stream">
    <meta name="twitter:description" content="Watch live PPV boxing and other sports in high quality.">
    <meta name="twitter:card" content="summary_large_image">
    <link rel="preconnect" href="https://fonts.bunny.net" crossorigin>
    <link href="https://fonts.bunny.net/css?family=kanit:100,200,300,400,500,600,700,800,900" rel="stylesheet"> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.1/css/bootstrap.min.css" integrity="sha512-Z/def5z5u2aR89OuzYcxmDJ0Bnd5V1cKqBEbvLOiUNWdg9PQeXVvXLI90SE4QOHGlfLqUnDNVAYyZi8UwUTmWQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="/assets/css/main.css?v=25">
  </head>
  <body>
    <!-- Top Bar -->
    <nav class="top-bar fixed-top">
      <div class="container-fluid">
        <button class="btn btn-dark" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebarMenu" aria-controls="sidebarMenu">
          <i class="fas fa-bars"></i>
        </button>
        <span class="futbolx-brand">FutbolX</span>
      </div>
    </nav>
    <!-- Left Sidebar -->
    <div class="offcanvas offcanvas-start" tabindex="-1" id="sidebarMenu" aria-labelledby="sidebarMenuLabel">
      <div class="offcanvas-header">
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>
      <div class="offcanvas-body">
        <ul class="nav flex-column">
          <li class="nav-item"><a class="nav-link" href="/request">Request</a></li>
          <li class="nav-item"><a class="nav-link" href="/vods">VODs</a></li>
          <li class="nav-item"><a class="nav-link" href="https://discord.gg/CmRcPbBB2k">Discord</a></li>
          <li class="nav-item"><a class="nav-link" href="/vip">VIP</a></li>
          <li class="nav-item"><a class="nav-link" href="/auth/login" id="loginLink">Login</a></li>
          <li class="nav-item"><button class="nav-link btn btn-link d-none" id="logoutButton">Logout</button></li>
          <li class="nav-item">
            <button id="themeToggle" class="nav-link btn btn-link" aria-label="Toggle theme">
              <i class="fas fa-moon"></i>
            </button>
          </li>
        </ul>
      </div>
    </div>
    <!-- Main Content -->
    <div class="container-fluid main-content">
      <div class="container">
        <a href="/" class="btn btn-back mt-4 mb-3"><i class="fas fa-arrow-left"></i> Back to Home</a>
        <div id="errorContainer" class="alert alert-danger d-none" role="alert"></div>
        <div class="video-container">
          <div id="player"></div>
        </div>
        <div class="stream-links mt-3"></div>
      </div>
      <footer class="container-fluid d-flex flex-column flex-lg-row justify-content-lg-between align-items-center py-2 border-top mt-5">
        <p class="mb-2 mb-lg-0 text-body-secondary text-center text-lg-start">FutbolX 2025</p>
        <ul class="nav justify-content-center justify-content-lg-end mb-0">
          <li class="nav-item"><a href="/api" class="nav-link px-2 text-body-secondary">API</a></li>
          <li class="nav-item"><a href="https://discord.gg/CmRcPbBB2k" class="nav-link px-2 text-body-secondary">Discord</a></li>
          <li class="nav-item"><a href="/changelog" class="nav-link px-2 text-body-secondary">Changelog</a></li>
          <li class="nav-item"><a href="/vip" class="nav-link px-2 text-body-secondary">Donate / VIP Access</a></li>
          <li class="nav-item"><a href="/contact" class="nav-link px-2 text-body-secondary">Contact us</a></li>
        </ul>
      </footer>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/clappr@latest/dist/clappr.min.js"></script>
    <script src="/assets/js/api.js"></script>
    <script async src="/assets/js/auth.js"></script>
    <script>
      function loadStream(api, streamUri) {
        const errorContainer = document.getElementById('errorContainer');
        const streamLinks = document.querySelector('.stream-links');
        const playerElement = document.getElementById('player');

        errorContainer.classList.add('d-none');
        errorContainer.innerHTML = '';
        streamLinks.innerHTML = '';

        fetchWithRetry(api.baseUrl + '/stream')
          .then(data => {
            if (!data || !data.success || !Array.isArray(data.streams)) {
              errorContainer.classList.remove('d-none');
              errorContainer.innerHTML = 'No streams are available right now. Check back later!';
              return;
            }

            let streamData = null;
            data.streams.forEach(category => {
              if (category.streams && Array.isArray(category.streams)) {
                const foundStream = category.streams.find(stream => stream.uri_name === streamUri);
                if (foundStream) streamData = foundStream;
              }
            });

            if (!streamData) {
              errorContainer.classList.remove('d-none');
              errorContainer.innerHTML = 'Stream not found!';
              return;
            }

            const now = Math.floor(Date.now() / 1000);
            const startTime = new Date(streamData.starts_at).getTime() / 1000;
            const endTime = streamData.ends_at ? new Date(streamData.ends_at).getTime() / 1000 : startTime + 3 * 3600;

            if (now < startTime) {
              errorContainer.classList.remove('d-none');
              errorContainer.innerHTML = `Stream "${streamData.name}" has not started yet. Check back later!`;
              return;
            }

            if (now > endTime && !streamData.always_live) {
              errorContainer.classList.remove('d-none');
              errorContainer.innerHTML = `Stream "${streamData.name}" has ended.`;
              return;
            }

            const sources = streamData.source || [];
            if (sources.length === 0) {
              errorContainer.classList.remove('d-none');
              errorContainer.innerHTML = 'No stream sources available!';
              return;
            }

            let player = new Clappr.Player({
              source: sources[0].url,
              parentId: '#player',
              autoPlay: true,
              width: '100%',
              height: '100%',
              playback: {
                hlsjsConfig: {
                  enableWorker: true,
                  maxBufferLength: 30,
                  liveSyncDurationCount: 3
                }
              },
              plugins: []
            });

            sources.forEach((source, index) => {
              const button = document.createElement('button');
              button.className = `btn btn-stream ${index === 0 ? 'active' : ''}`;
              button.textContent = source.label || `Source ${index + 1}`;
              button.addEventListener('click', () => {
                document.querySelectorAll('.btn-stream').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                player.load(source.url);
              });
              streamLinks.appendChild(button);
            });
          })
          .catch(error => {
            console.error('API Fetch Error:', error);
            errorContainer.classList.remove('d-none');
            errorContainer.innerHTML = 'Error loading stream. Please try again later.';
          });
      }

      function fetchWithRetry(url, maxRetries = 3, delay = 1000) {
        return new Promise((resolve, reject) => {
          let attempts = 0;
          function attempt() {
            attempts++;
            console.log(`Fetching ${url}, attempt ${attempts}`);
            fetch(url)
              .then(res => {
                console.log(`Fetch status: ${res.status}`);
                if (!res.ok) throw new Error(`HTTP error ${res.status}`);
                return res.json();
              })
              .then(data => resolve(data))
              .catch(error => {
                console.error(`Fetch attempt ${attempts} failed:`, error);
                if (attempts < maxRetries) {
                  setTimeout(attempt, delay);
                } else {
                  reject(error);
                }
              });
          }
          attempt();
        });
      }

      function initPage() {
        try {
          console.log('Initializing page at', new Date().toISOString());
          const htmlElement = document.documentElement;
          const themeToggle = document.getElementById('themeToggle');
          const currentTheme = localStorage.getItem('theme') || 'dark';
          htmlElement.setAttribute('data-bs-theme', currentTheme);
          themeToggle.innerHTML = currentTheme === 'dark' ? '<i class="fas fa-moon"></i>' : '<i class="fas fa-sun"></i>';
          
          themeToggle.addEventListener('click', () => {
            const newTheme = htmlElement.getAttribute('data-bs-theme') === 'dark' ? 'light' : 'dark';
            htmlElement.setAttribute('data-bs-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            themeToggle.innerHTML = newTheme === 'dark' ? '<i class="fas fa-moon"></i>' : '<i class="fas fa-sun"></i>';
          });

          const offcanvasElement = document.getElementById('sidebarMenu');
          document.addEventListener('click', (event) => {
            const toggler = document.querySelector('[data-bs-toggle="offcanvas"]');
            const isOffcanvasOpen = offcanvasElement.classList.contains('show');
            const clickedInside = offcanvasElement.contains(event.target) || toggler.contains(event.target);
            if (isOffcanvasOpen && !clickedInside) {
              bootstrap.Offcanvas.getOrCreateInstance(offcanvasElement).hide();
            }
          });

          const streamUri = window.location.pathname.split('/').pop();
          if (typeof Api === 'undefined') {
            console警告('Api class not defined. Using default API path.');
            const api = { baseUrl: window.location.origin };
            loadStream(api, streamUri);
          } else {
            const api = new Api(`${window.location.origin}/api`);
            loadStream(api, streamUri);
          }

          checkAuthStatus();
          console.log('Page initialized successfully');
        } catch (error) {
          console.error('Init page error:', error);
          const errorContainer = document.getElementById('errorContainer');
          errorContainer.classList.remove('d-none');
          errorContainer.innerHTML = 'Error initializing page. Please try again later.';
        }
      }

      document.addEventListener('DOMContentLoaded', () => {
        console.log('DOM loaded at', new Date().toISOString());
        initPage();
      });
    </script>
  </body>
</html>
