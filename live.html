<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>FutbolX - Live Stream</title>
  <meta name="description" content="Watch live PPV streams on FutbolX.">
  <meta name="keywords" content="futbolx, ppv, free ppv, boxing, ufc, basketball, football, stream, online, free">
  <meta property="og:title" content="FutbolX - Live Stream" />
  <meta property="og:url" content="https://your-futbolx-site.vercel.app/live" />
  <meta property="og:image" content="/assets/img/og-image.jpg">
  <meta name="twitter:title" content="FutbolX - Live Stream">
  <meta name="twitter:description" content="Watch live PPV streams on FutbolX.">
  <meta name="twitter:card" content="summary_large_image">
  <link rel="preconnect" href="https://fonts.bunny.net" crossorigin="anonymous">
  <link href="https://fonts.bunny.net/css?family=kanit:100,200,300,400,500,600,700,800,900" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.1/css/bootstrap.min.css" integrity="sha512-Z/def5z5u2aR89OuzYcxmDJ0Bnd5V1cKqBEbvLOiUNWdg9PQeXVvXLI90SE4QOHGlfLqUnDNVAYyZi8UwUTmWQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="/assets/css/main.css?v=26">
  <script src="https://cdn.jsdelivr.net/npm/jwplayer@8.20.0/jwplayer.js"></script>
  <script src="https://unpkg.com/@stream-io/stream-chat-react@10.8.9/dist/js/stream-chat-react.js"></script>
  <style>
    .stream-container { position: relative; padding-top: 56.25%; margin-bottom: 20px; }
    #player { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
    .stream-buttons { display: flex; gap: 10px; margin-bottom: 20px; justify-content: center; }
    .chat-container { max-width: 500px; margin: 0 auto; }
    .error-alert { max-width: 500px; margin: 20px auto; }
  </style>
</head>
<body>
  <nav class="top-bar fixed-top">
    <div class="container-fluid">
      <button class="btn btn-dark" type="button" id="sidebarToggler" data-bs-toggle="offcanvas" data-bs-target="#sidebarMenu" aria-controls="sidebarMenu">
        <i class="fas fa-bars"></i>
      </button>
      <span class="futbolx-brand">FutbolX</span>
    </div>
  </nav>
  <div class="offcanvas offcanvas-start" tabindex="-1" id="sidebarMenu" aria-labelledby="sidebarMenuLabel">
    <div class="offcanvas-header">
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
      <ul class="nav flex-column">
        <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
        <li class="nav-item"><a class="nav-link" href="/request">Request</a></li>
        <li class="nav-item"><a class="nav-link" href="/vods">VODs</a></li>
        <li class="nav-item"><a class="nav-link" href="https://discord.gg/CmRcPbBB2k">Discord</a></li>
        <li class="nav-item"><a class="nav-link" href="/vip">VIP</a></li>
        <li class="nav-item"><a class="nav-link" href="/auth/login" id="loginLink">Login</a></li>
        <li class="nav-item"><button class="nav-link btn btn-link d-none" id="logoutButton">Logout</button></li>
        <li class="nav-item">
          <button id="themeToggle" class="nav-link btn btn-link" aria-label="Toggle theme">
            <i class="fas fa-moon"></i>
          </button>
        </li>
      </ul>
    </div>
  </div>
  <div class="container-fluid main-content">
    <div class="container pt-2">
      <div id="errorContainer" class="d-none error-alert"></div>
      <h1 id="streamTitle" class="text-center my-4">Loading...</h1>
      <div class="stream-container">
        <div id="player"></div>
      </div>
      <div class="stream-buttons text-center"></div>
      <div class="chat-container">
        <div id="chat"></div>
      </div>
    </div>
    <footer class="container-fluid d-flex flex-column flex-lg-row justify-content-lg-between align-items-center py-2 border-top mt-5">
      <p class="mb-2 mb-lg-0 text-body-secondary text-center text-lg-start">FutbolX 2025</p>
      <ul class="nav justify-content-center justify-content-lg-end mb-0">
        <li class="nav-item"><a href="/api" class="nav-link px-2 text-body-secondary">API</a></li>
        <li class="nav-item"><a href="https://discord.gg/CmRcPbBB2k" class="nav-link px-2 text-body-secondary">Discord</a></li>
        <li class="nav-item"><a href="/changelog" class="nav-link px-2 text-body-secondary">Changelog</a></li>
        <li class="nav-item"><a href="/vip" class="nav-link px-2 text-body-secondary">Donate / VIP Access</a></li>
        <li class="nav-item"><a href="/contact" class="nav-link px-2 text-body-secondary">Contact us</a></li>
      </ul>
    </footer>
  </div>
  <script src="/_vercel/insights/script.js" defer></script>
  <script src="/_vercel/speed-insights/script.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm" crossorigin="anonymous"></script>
  <script src="/assets/js/api.js"></script>
  <script async src="/assets/js/auth.js"></script>
  <script>
    window.plausible = window.plausible || function() { (window.plausible.q = window.plausible.q || []).push(arguments) };
    jwplayer.key = 'IDzF9Zmk';

    let streamClient;
    let channel;

    function clearError() {
      const errorContainer = document.getElementById('errorContainer');
      if (errorContainer && !errorContainer.classList.contains('d-none')) {
        errorContainer.classList.add('fade-out');
        setTimeout(() => {
          errorContainer.className = 'd-none error-alert';
          errorContainer.innerHTML = '';
        }, 500);
      }
    }

    async function fetchWithRetry(url, maxRetries = 3, delay = 1000) {
      return new Promise((resolve, reject) => {
        let attempts = 0;
        async function attempt() {
          attempts++;
          console.log(`Fetching ${url}, attempt ${attempts}`);
          try {
            const res = await fetch(url, { signal: AbortSignal.timeout(5000) });
            console.log(`Fetch status: ${res.status} ${res.statusText}`);
            if (!res.ok) {
              const text = await res.text();
              console.error(`HTTP error response for ${url}: ${text.substring(0, 200)}...`);
              throw new Error(`HTTP error ${res.status}: ${res.statusText} - ${text.substring(0, 200)}...`);
            }
            const data = await res.json();
            clearError();
            resolve(data);
          } catch (error) {
            console.error(`Fetch attempt ${attempts} failed for ${url}:`, error);
            if (attempts < maxRetries) {
              setTimeout(attempt, delay);
            } else {
              reject(error);
            }
          }
        }
        attempt();
      });
    }

    async function initChat(userId, token, streamName) {
      try {
        streamClient = StreamChat.getInstance('YOUR_STREAM_API_KEY'); // Replace with your Stream API key
        await streamClient.connectUser({ id: userId }, token);
        channel = streamClient.channel('livestream', streamName.replace(/\s+/g, '-').toLowerCase());
        await channel.watch();
        const chatContainer = document.getElementById('chat');
        chatContainer.innerHTML = ''; // Clear any loading state
        const chat = new StreamChatReact.Chat({ client: streamClient });
        const channelComponent = new StreamChatReact.Channel({ channel });
        const messageList = new StreamChatReact.MessageList();
        const messageInput = new StreamChatReact.MessageInput();
        chat.render(chatContainer);
        channelComponent.render(chatContainer);
        messageList.render(chatContainer);
        messageInput.render(chatContainer);
        console.log(`Chat initialized for channel: ${channel.id}`);
      } catch (error) {
        console.error('Chat initialization error:', error);
        document.getElementById('errorContainer').className = 'alert alert-danger error-alert';
        document.getElementById('errorContainer').innerHTML = 'Failed to load chat. Please try again.';
      }
    }

    async function initStream() {
      const errorContainer = document.getElementById('errorContainer');
      const streamTitle = document.getElementById('streamTitle');
      const streamButtons = document.querySelector('.stream-buttons');
      const path = window.location.pathname.split('/').pop();
      
      try {
        const apiInstance = typeof Api !== 'undefined' ? new Api(`${window.location.origin}/api`) : { baseUrl: window.location.origin + '/api' };
        const apiUrl = apiInstance.baseUrl.endsWith('/') ? `${apiInstance.baseUrl}stream` : `${apiInstance.baseUrl}/stream`;
        console.log(`Fetching stream data from: ${apiUrl}`);
        const streamData = await fetchWithRetry(apiUrl);

        if (!streamData || !streamData.success || !Array.isArray(streamData.streams)) {
          throw new Error('Invalid stream data');
        }

        let selectedStream = null;
        streamData.streams.forEach(category => {
          if (category.streams && Array.isArray(category.streams)) {
            category.streams.forEach(stream => {
              if (stream.uri_name === path) {
                selectedStream = stream;
              }
            });
          }
        });

        if (!selectedStream) {
          throw new Error('Stream not found for path: ' + path);
        }

        streamTitle.innerHTML = selectedStream.name;
        streamButtons.innerHTML = selectedStream.streams.map((stream, index) => `
          <button class="btn btn-danger btn-sm stream-button" data-url="${stream.url}" data-type="${stream.url.endsWith('.m3u8') ? 'hls' : 'mp4'}">${stream.title}</button>
        `).join('');

        const player = jwplayer('player').setup({
          file: selectedStream.streams[0].url,
          type: selectedStream.streams[0].url.endsWith('.m3u8') ? 'hls' : 'mp4',
          width: '100%',
          aspectratio: '16:9'
        });

        document.querySelectorAll('.stream-button').forEach(button => {
          button.addEventListener('click', () => {
            const url = button.getAttribute('data-url');
            const type = button.getAttribute('data-type');
            player.setup({ file: url, type });
            console.log(`Switched to stream: ${url} (${type})`);
          });
        });

        const tokenResponse = await fetchWithRetry('/api/stream-token');
        await initChat(tokenResponse.userId, tokenResponse.token, selectedStream.name);
        console.log('Stream and chat initialized successfully');

      } catch (error) {
        console.error('Stream initialization error:', error);
        streamTitle.innerHTML = 'Error loading stream';
        errorContainer.className = 'alert alert-danger error-alert';
        errorContainer.innerHTML = `Failed to load stream: ${error.message}. Please try again.`;
      }
    }

    function initOffcanvas() {
      const offcanvasElement = document.getElementById('sidebarMenu');
      const toggler = document.getElementById('sidebarToggler');
      
      if (!offcanvasElement || !toggler) {
        console.error('Offcanvas or toggler not found');
        return;
      }

      try {
        const offcanvas = new bootstrap.Offcanvas(offcanvasElement);
        offcanvasElement.addEventListener('hidden.bs.offcanvas', () => {
          console.log('Offcanvas closed');
        });

        const navLinks = offcanvasElement.querySelectorAll('.nav-link');
        navLinks.forEach(link => {
          link.addEventListener('click', (event) => {
            event.stopPropagation();
            const href = link.getAttribute('href');
            if (href) {
              console.log('Nav link clicked:', href);
              window.location.href = href;
            }
          });
        });

        const logoutButton = document.getElementById('logoutButton');
        if (logoutButton) {
          logoutButton.addEventListener('click', (event) => {
            event.stopPropagation();
            console.log('Logout button clicked');
          });
        }
      } catch (error) {
        console.error('Offcanvas initialization error:', error);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      console.log('DOM loaded at', new Date().toISOString());
      const themeToggle = document.getElementById('themeToggle');
      const htmlElement = document.documentElement;
      const currentTheme = localStorage.getItem('theme') || 'dark';
      htmlElement.setAttribute('data-bs-theme', currentTheme);
      if (themeToggle) {
        themeToggle.innerHTML = currentTheme === 'dark' ? '<i class="fas fa-moon"></i>' : '<i class="fas fa-sun"></i>';
        themeToggle.addEventListener('click', () => {
          console.log('Theme toggle clicked');
          const newTheme = htmlElement.getAttribute('data-bs-theme') === 'dark' ? 'light' : 'dark';
          htmlElement.setAttribute('data-bs-theme', newTheme);
          localStorage.setItem('theme', newTheme);
          themeToggle.innerHTML = newTheme === 'dark' ? '<i class="fas fa-moon"></i>' : '<i class="fas fa-sun"></i>';
        });
      } else {
        console.error('Theme toggle element not found');
      }

      initOffcanvas();
      initStream();
      try {
        checkAuthStatus();
      } catch (error) {
        console.warn('Auth status check failed:', error);
      }
    });
  </script>
</body>
</html>
