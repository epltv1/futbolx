<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>FutbolX - Watch PPV Events</title>
    <meta name="description" content="FutbolX - Watch PPV boxing, UFC, Basketball, Football, and more for free.">
    <meta name="keywords" content="futbolx, ppv, free ppv, boxing, ufc, basketball, football, stream, online, free">
    <meta property="og:title" content="FutbolX - Watch PPV Events" />
    <meta property="og:url" content="https://your-futbolx-site.vercel.app/" />
    <meta property="og:image" content="/assets/img/og-image.jpg">
    <meta name="twitter:title" content="FutbolX - Watch PPV Events">
    <meta name="twitter:description" content="Watch PPV boxing, UFC, and more on FutbolX for free.">
    <meta name="twitter:card" content="summary_large_image">
    <link rel="preconnect" href="https://fonts.bunny.net" crossorigin>
    <link href="https://fonts.bunny.net/css?family=kanit:100,200,300,400,500,600,700,800,900" rel="stylesheet"> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.1/css/bootstrap.min.css" integrity="sha512-Z/def5z5u2aR89OuzYcxmDJ0Bnd5V1cKqBEbvLOiUNWdg9PQeXVvXLI90SE4QOHGlfLqUnDNVAYyZi8UwUTmWQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="/assets/css/main.css?v=17">
  </head>
  <body>
    <!-- Top Bar -->
    <nav class="top-bar fixed-top">
      <div class="container-fluid">
        <button class="btn btn-dark d-lg-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebarMenu" aria-controls="sidebarMenu">
          <i class="fas fa-bars"></i>
        </button>
        <span class="futbolx-brand">FutbolX</span>
      </div>
    </nav>
    <!-- Left Sidebar -->
    <div class="offcanvas offcanvas-start" tabindex="-1" id="sidebarMenu" aria-labelledby="sidebarMenuLabel">
      <div class="offcanvas-header">
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>
      <div class="offcanvas-body">
        <ul class="nav flex-column">
          <li class="nav-item"><a class="nav-link" href="/request">Request</a></li>
          <li class="nav-item"><a class="nav-link" href="/vods">VODs</a></li>
          <li class="nav-item"><a class="nav-link" href="https://discord.gg/5AMPdpckjH">Discord</a></li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">Language</a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="#" onclick="document.cookie = 'fs_locale=en; expires=Mon, 18 Jan 2038 12:00:00 UTC; path=/';location.reload();">English</a></li>
              <li><a class="dropdown-item" href="#" onclick="document.cookie = 'fs_locale=de; expires=Mon, 18 Jan 2038 12:00:00 UTC; path=/';location.reload();">Deutsch</a></li>
              <li><a class="dropdown-item" href="#" onclick="document.cookie = 'fs_locale=es; expires=Mon, 18 Jan 2038 12:00:00 UTC; path=/';location.reload();">Espa√±ol</a></li>
            </ul>
          </li>
          <li class="nav-item"><a class="nav-link" href="/auth/login" id="loginLink">Login</a></li>
          <li class="nav-item"><button class="nav-link btn btn-link d-none" id="logoutButton">Logout</button></li>
          <li class="nav-item">
            <button id="themeToggle" class="nav-link btn btn-link" aria-label="Toggle theme">
              <i class="fas fa-moon"></i>
            </button>
          </li>
        </ul>
      </div>
    </div>
    <!-- Main Content -->
    <div class="container-fluid main-content">
      <div class="container mt-4">
        <div id="loading" class="text-center">Loading streams...</div>
        <div id="streamError" class="alert alert-danger mt-3 d-none"></div>
        <div id="liveNow" class="mb-5"></div>
        <div id="categories"></div>
        <footer class="container-fluid d-flex flex-column flex-lg-row justify-content-lg-between align-items-center py-2 border-top mt-5">
          <p class="mb-2 mb-lg-0 text-body-secondary text-center text-lg-start">FutbolX 2025</p>
          <ul class="nav justify-content-center justify-content-lg-end mb-0">
            <li class="nav-item"><a href="/api" class="nav-link px-2 text-body-secondary">API</a></li>
            <li class="nav-item"><a href="https://discord.gg/5AMPdpckjH" class="nav-link px-2 text-body-secondary">Discord</a></li>
            <li class="nav-item"><a href="/changelog" class="nav-link px-2 text-body-secondary">Changelog</a></li>
            <li class="nav-item"><a href="/vip" class="nav-link px-2 text-body-secondary">Donate / VIP Access</a></li>
            <li class="nav-item"><a href="/contact" class="nav-link px-2 text-body-secondary">Contact us</a></li>
          </ul>
        </footer>
      </div>
    </div>
    <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm" crossorigin="anonymous"></script>
    <script async src="/assets/js/api.js"></script>
    <script async src="/assets/js/auth.js"></script>
    <script defer>
      function renderEventCard(event, isLive = false) {
        const startDate = new Date(event.starts_at);
        const endDate = new Date(event.ends_at);
        const now = new Date();
        const isEventLive = now >= startDate && now <= endDate;
        const countdown = now < startDate ? Math.ceil((startDate - now) / (1000 * 60 * 60)) + 'h' : '';
        const time = startDate.toLocaleString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true });
        return `
          <a href="/live/${event.uri_name}" class="card-link" data-navigate>
            <div class="card event-card">
              ${isEventLive ? '<span class="live-badge">Live <span class="live-animation"></span></span>' : ''}
              <img src="${event.thumbnail || 'https://via.placeholder.com/300x160'}" class="card-img-top" alt="${event.name}">
              <div class="card-body">
                <h5 class="card-title">${event.name}</h5>
                <p class="card-text">${event.description || ''}</p>
                <p class="card-text"><small class="text-muted">${time}${countdown ? ' (' + countdown + ')' : ''}</small></p>
              </div>
            </div>
          </a>
        `;
      }

      function initPage() {
        try {
          // Initialize theme
          const htmlElement = document.documentElement;
          const themeToggle = document.getElementById('themeToggle');
          const currentTheme = localStorage.getItem('theme') || 'dark';
          htmlElement.setAttribute('data-bs-theme', currentTheme);
          themeToggle.innerHTML = currentTheme === 'dark' ? '<i class="fas fa-moon"></i>' : '<i class="fas fa-sun"></i>';
          
          // Theme toggle event
          themeToggle.addEventListener('click', () => {
            const newTheme = htmlElement.getAttribute('data-bs-theme') === 'dark' ? 'light' : 'dark';
            htmlElement.setAttribute('data-bs-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            themeToggle.innerHTML = newTheme === 'dark' ? '<i class="fas fa-moon"></i>' : '<i class="fas fa-sun"></i>';
          });

          // Offcanvas outside click
          document.addEventListener('click', function(event) {
            const offcanvas = document.getElementById('sidebarMenu');
            const toggler = document.querySelector('[data-bs-toggle="offcanvas"]');
            const isOffcanvasOpen = offcanvas.classList.contains('show');
            const clickedInsideOffcanvas = offcanvas.contains(event.target) || toggler.contains(event.target);
            if (isOffcanvasOpen && !clickedInsideOffcanvas) {
              bootstrap.Offcanvas.getInstance(offcanvas).hide();
            }
          });

          // Load streams
          const api = new Api(`${window.location.origin}/api`);
          const loading = document.getElementById('loading');
          const streamError = document.getElementById('streamError');
          const liveNow = document.getElementById('liveNow');
          const categories = document.getElementById('categories');
          fetch(api.baseUrl + '/stream')
            .then(res => {
              if (!res.ok) throw new Error(`HTTP error ${res.status}`);
              return res.json();
            })
            .then(data => {
              loading.style.display = 'none';
              if (!data || !data.success || !Array.isArray(data.streams)) {
                streamError.className = 'alert alert-danger mt-3';
                streamError.innerText = 'No streams available.';
                return;
              }
              const now = new Date();
              let liveEvents = [];
              let categoryEvents = {};
              data.streams.forEach(category => {
                if (category.streams && Array.isArray(category.streams)) {
                  category.streams.forEach(event => {
                    const startDate = new Date(event.starts_at);
                    const endDate = new Date(event.ends_at);
                    if (now >= startDate && now <= endDate) {
                      liveEvents.push(event);
                    } else if (now < endDate) {
                      if (!categoryEvents[category.name]) {
                        categoryEvents[category.name] = [];
                      }
                      categoryEvents[category.name].push(event);
                    }
                  });
                }
              });
              // Render Live Now
              if (liveEvents.length > 0) {
                liveNow.innerHTML = `
                  <h2>Live Now</h2>
                  <div class="event-grid">
                    ${liveEvents.map(event => renderEventCard(event, true)).join('')}
                  </div>
                `;
              }
              // Render Categories
              categories.innerHTML = Object.keys(categoryEvents)
                .map(category => `
                  <div class="mb-5">
                    <h2>${category}</h2>
                    <div class="event-grid">
                      ${categoryEvents[category].map(event => renderEventCard(event)).join('')}
                    </div>
                  </div>
                `)
                .join('');
            })
            .catch(error => {
              console.error('Stream fetch error:', error);
              loading.style.display = 'none';
              streamError.className = 'alert alert-danger mt-3';
              streamError.innerText = 'Failed to load streams. Please check your connection or refresh the page.';
            });

          checkAuthStatus(); // Initialize auth status
        } catch (error) {
          console.error('Init page error:', error);
          document.getElementById('loading').style.display = 'none';
          document.getElementById('streamError').className = 'alert alert-danger mt-3';
          document.getElementById('streamError').innerText = 'An error occurred. Please refresh the page.';
        }
      }

      document.addEventListener('DOMContentLoaded', () => {
        console.log('DOM loaded at', new Date().toISOString());
        initPage();
      });

      // Handle dynamic navigation
      document.addEventListener('click', function(event) {
        const link = event.target.closest('[data-navigate]');
        if (link) {
          event.preventDefault();
          const url = link.getAttribute('href');
          history.pushState({}, '', url);
          loadPage(url);
        }
      });

      window.addEventListener('popstate', function(event) {
        loadPage(window.location.pathname);
      });

      function loadPage(url) {
        console.log('Loading page:', url);
        fetch(url)
          .then(response => {
            if (!response.ok) throw new Error(`HTTP error ${response.status}`);
            return response.text();
          })
          .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            document.body.innerHTML = doc.body.innerHTML;
            document.title = doc.title;
            // Reinitialize scripts
            const scripts = document.createElement('script');
            scripts.textContent = `
              ${initPage.toString()}
              document.addEventListener('DOMContentLoaded', initPage);
            `;
            document.body.appendChild(scripts);
            // Trigger DOMContentLoaded
            const event = new Event('DOMContentLoaded');
            document.dispatchEvent(event);
            console.log('Page loaded:', url);
          })
          .catch(error => {
            console.error('Navigation error:', error);
            window.location.href = url; // Fallback to full reload
          });
      }
    </script>
  </body>
</html>
