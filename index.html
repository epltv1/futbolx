<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>FutbolX - Free PPV and More</title>
  <meta name="description" content="FutbolX - Free PPV boxing, UFC, Basketball, Football, and more available live and on-demand.">
  <meta name="keywords" content="futbolx, ppv, free ppv, boxing, ufc, basketball, football, stream, online, free">
  <meta property="og:title" content="FutbolX - Free PPV and More" />
  <meta property="og:url" content="https://your-futbolx-site.vercel.app" />
  <meta property="og:image" content="/assets/img/og-image.jpg">
  <meta name="twitter:title" content="FutbolX - Free PPV and More">
  <meta name="twitter:description" content="Free PPV boxing and other content available live and on-demand.">
  <meta name="twitter:card" content="summary_large_image">
  <link rel="preconnect" href="https://fonts.bunny.net" crossorigin="anonymous">
  <link href="https://fonts.bunny.net/css?family=kanit:100,200,300,400,500,600,700,800,900" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.1/css/bootstrap.min.css" integrity="sha512-Z/def5z5u2aR89OuzYcxmDJ0Bnd5V1cKqBEbvLOiUNWdg9PQeXVvXLI90SE4QOHGlfLqUnDNVAYyZi8UwUTmWQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="/assets/css/main.css?v=24">
  <style>
    .error-alert { max-width: 500px; margin: 20px auto; }
    .event-card { opacity: 0; transform: translateY(50px); transition: opacity 0.6s ease-out, transform 0.6s ease-out; }
    .event-card.visible { opacity: 1; transform: translateY(0); }
    .card-title.non-clickable, .event-tag { pointer-events: none; }
  </style>
</head>
<body>
  <!-- Top Bar -->
  <nav class="top-bar fixed-top">
    <div class="container-fluid">
      <button class="btn btn-dark" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebarMenu" aria-controls="sidebarMenu">
        <i class="fas fa-bars"></i>
      </button>
      <span class="futbolx-brand">FutbolX</span>
    </div>
  </nav>
  <!-- Left Sidebar -->
  <div class="offcanvas offcanvas-start" tabindex="-1" id="sidebarMenu" aria-labelledby="sidebarMenuLabel">
    <div class="offcanvas-header">
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
      <ul class="nav flex-column">
        <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
        <li class="nav-item"><a class="nav-link" href="/request">Request</a></li>
        <li class="nav-item"><a class="nav-link" href="/vods">VODs</a></li>
        <li class="nav-item"><a class="nav-link" href="https://discord.gg/CmRcPbBB2k">Discord</a></li>
        <li class="nav-item"><a class="nav-link" href="/vip">VIP</a></li>
        <li class="nav-item"><a class="nav-link" href="/auth/login" id="loginLink">Login</a></li>
        <li class="nav-item"><button class="nav-link btn btn-link d-none" id="logoutButton">Logout</button></li>
        <li class="nav-item">
          <button id="themeToggle" class="nav-link btn btn-link" aria-label="Toggle theme">
            <i class="fas fa-moon"></i>
          </button>
        </li>
      </ul>
    </div>
  </div>
  <!-- Main Content -->
  <div class="container-fluid main-content">
    <div class="text-center py-5 bg-dark hero-background">
      <h1 class="display-4 fw-bold">Welcome to FutbolX</h1>
      <p class="lead">Stream Free PPV Boxing, UFC, Basketball, and More - Live & On-Demand!</p>
    </div>
    <div class="container pt-2">
      <div id="errorContainer" class="d-none error-alert"></div>
      <div id="live" class="mt-4">
        <h2 class="m-0">
          Live Now <span id="liveAnimation" class="live-animation d-none"></span>
        </h2>
        <div id="livecards" class="event-grid py-3">
          <p>Loading streams...</p>
        </div>
      </div>
      <div id="football" class="mt-5 d-none">
        <h2 class="m-0">Football</h2>
        <div id="footballcards" class="event-grid py-3"></div>
      </div>
      <div id="nba" class="mt-5 d-none">
        <h2 class="m-0">NBA</h2>
        <div id="nbacards" class="event-grid py-3"></div>
      </div>
      <div id="fights" class="mt-5 d-none">
        <h2 class="m-0">Fights</h2>
        <div id="fightscards" class="event-grid py-3"></div>
      </div>
      <div id="motorsports" class="mt-5 d-none">
        <h2 class="m-0">Motorsports</h2>
        <div id="motorsportscards" class="event-grid py-3"></div>
      </div>
      <div id="nfl" class="mt-5 d-none">
        <h2 class="m-0">NFL</h2>
        <div id="nflcards" class="event-grid py-3"></div>
      </div>
      <div id="nhl" class="mt-5 d-none">
        <h2 class="m-0">NHL</h2>
        <div id="nhlcards" class="event-grid py-3"></div>
      </div>
      <div id="mlb" class="mt-5 d-none">
        <h2 class="m-0">MLB</h2>
        <div id="mlbcards" class="event-grid py-3"></div>
      </div>
      <div id="icehockey" class="mt-5 d-none">
        <h2 class="m-0">Ice Hockey</h2>
        <div id="icehockeycards" class="event-grid py-3"></div>
      </div>
      <div id="tennis" class="mt-5 d-none">
        <h2 class="m-0">Tennis</h2>
        <div id="tenniscards" class="event-grid py-3"></div>
      </div>
      <div id="rugby" class="mt-5 d-none">
        <h2 class="m-0">Rugby</h2>
        <div id="rugbycards" class="event-grid py-3"></div>
      </div>
      <div id="golf" class="mt-5 d-none">
        <h2 class="m-0">Golf</h2>
        <div id="golfcards" class="event-grid py-3"></div>
      </div>
      <div id="others" class="mt-5 d-none">
        <h2 class="m-0">Others</h2>
        <div id="otherscards" class="event-grid py-3"></div>
      </div>
      <footer class="container-fluid d-flex flex-column flex-lg-row justify-content-between align-items-center py-2 border-top mt-5">
        <p class="mb-2 mb-lg-0 text-body-secondary text-center text-lg-start">FutbolX 2025</p>
        <ul class="nav justify-content-center justify-content-lg-end mb-0">
          <li class="nav-item"><a href="/api" class="nav-link px-2 text-body-secondary">API</a></li>
          <li class="nav-item"><a href="https://discord.gg/CmRcPbBB2k" class="nav-link px-2 text-body-secondary">Discord</a></li>
          <li class="nav-item"><a href="/changelog" class="nav-link px-2 text-body-secondary">Changelog</a></li>
          <li class="nav-item"><a href="/vip" class="nav-link px-2 text-body-secondary">Donate / VIP Access</a></li>
          <li class="nav-item"><a href="/contact" class="nav-link px-2 text-body-secondary">Contact us</a></li>
        </ul>
      </footer>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVZ7610L5p0S3vS4S2qP0S3vS2qP0L5p0S3" crossorigin="anonymous"></script>
  <script src="/assets/js/api.js"></script>
  <script async src="/assets/js/auth.js"></script>
  <script defer data-domain="your-futbolx-site.vercel.app" src="https://p.vidembed.re/js/script.js"></script>
  <script>
    window.plausible = window.plausible || function() { (window.plausible.q = window.plausible.q || []).push(arguments) };
    
    let lastApiCall = 0;
    let apiInstance = null;

    function zeropad(num) {
      return num > 9 ? num : '0' + num;
    }

    function countDown() {
      const now = Math.floor(Date.now() / 1000);
      let needsRefresh = false;
      const countdownElements = document.querySelectorAll('[data-start]');
      countdownElements.forEach(element => {
        const startTime = parseInt(element.getAttribute('data-start'), 10);
        let timer = startTime - startTime;
        const uri = element.getAttribute('data-uri');
        const cardLink = element.closest('.card-link');
        if (timer > 0) {
          let days = Math.floor(timer / 86400);
          let weeks = Math.floor(days / 7);
          let hours = Math.floor(timer / 3600);
          let minutes = Math.floor(timer / 60);
          let seconds = Math.floor(timer);
          let displayText = '';
          if (days >= 7) {
            displayText = `Starting in ${weeks} week${weeks > 1 ? 's' : ''}`;
          } else if (days >= 1) {
            displayText = `Starting in ${days} day${days > 1 ? 's' : ''}`;
          } else {
            let hh = hours - days * 24;
            let mm = minutes - hours * 60;
            let ss = seconds - minutes * 60;
            displayText = `${zeropad(hh)}:${zeropad(mm)}:${zeropad(ss)}`;
          }
          if (element.innerHTML !== displayText) {
            element.innerHTML = displayText;
          }
          if (timer <= 1800 && cardLink && cardLink.style.pointerEvents !== 'auto') {
            cardLink.style.pointerEvents = 'auto';
            cardLink.style.cursor = 'pointer';
          } else if (timer > 1800 && cardLink && cardLink.style.pointerEvents !== 'none') {
            cardLink.style.pointerEvents = 'none';
            cardLink.style.cursor = 'default';
          }
          if (timer <= 1 && timer > 0) {
            needsRefresh = true;
          }
        } else if (timer <= 0 && !element.innerHTML.includes('watch-button')) {
          element.innerHTML = `<a href="${uri}" class="btn btn-danger btn-sm">Watch Now</a>`;
          if (cardLink) {
            cardLink.style.pointerEvents = 'auto';
            cardLink.style.cursor = 'pointer';
          }
          needsRefresh = true;
        }
      });
      if (needsRefresh && apiInstance) {
        const currentTime = Date.now();
        if (currentTime - lastApiCall >= 1000) {
          lastApiCall = currentTime;
          loadContent(apiInstance);
        }
      }
      setInterval(countDown, 1000);
    }

    function fetchWithRetry(url, options = { maxRetries: 3, retryDelay: 1000 }) {
      return new Promise((resolve, reject) => {
        let attempts = 0;
        function attempt() {
          attempts++;
          console.log(`Fetching ${url}, attempt ${attempts}`);
          fetch(url)
            .then(res => {
              console.log(`Fetch status: ${res.status}`);
              if (!res.ok) throw new Error(`HTTP error ${res.status}: ${res.statusText}`);
              return res.json();
            })
            .then(data => resolve(data))
            .catch(error => {
              console.error(`Fetch attempt ${attempts} failed:`, error);
              if (attempts < maxRetries) {
                setTimeout(attempt, options.retryDelay);
              } else {
                reject(error);
              }
            });
          }
          attempt();
        });
      }

      function loadContent(api) {
        console.log('Starting loadContent at', new Date().toISOString());
        const errorContainer = document.getElementById('errorContainer');
        const liveContentContainer = document.getElementById('livecards');
        const liveAnimation = document.getElementById('liveAnimation');

        errorContainer.classList.add('d-none');
        errorContainer.innerHTML = '';
        liveContainer.innerHTML = '<p>Loading streams...</p>';

        fetchWithRetry(api.baseUrl + '/api/stream')
          .then(data => {
            console.log('Stream API Response:', data);

            if (!data || !data.success || !Array.isArray(data.results)) {
              console.warn('Invalid stream data received');
              liveContentContainer.innerHTML = '<p>No streams available right now. Check back later!</p>';
              liveAnimation.classList.add('d-none');
              errorContainer.className = 'alert alert-danger error-alert';
              errorContainer.innerText = 'Failed to load streams. Please try again later.';
              return;
            }

            const categories = {
              football: { id: 'football', element: document.getElementById('footballcards') },
              nba: { id: 'nba', elementId: document.getElementById('nbacards') },
              fights: { id: 'fights', elementId: document.getElementById('fightscards') },
              motorsports: { id: 'motorsports', elementId: document.getElementById('motorsportscards') },
              nfl:,: { id: 'nfl', elementId: document.getElementById('nflcards') },
              nhl: { id: 'nhl', element: document.getElementById('nhlcards') },
              mlb: { id: 'mlb', elementId: document.getElementById('mlbcards') },
              icehockey: { id: 'icehockey', element: document.getElementById('icehockeycards') },
              tennis: { id: 'tennis', elementId: document.getElementById('tenniscards') },
              rugby: { id: 'rugby', elementId: document.getElementById('rugbycards') },
              golf: { id: 'golf', element: document.getElementById('golfcards') },
              others: { id: 'others', element: document.getElementById('otherscards') }
            };
            
            Object.values(categories).forEach(cat => {
              if (cat.element) cat.element.innerHTML = '';
            });
            Object.keys(categories).forEach(key => {
              const element = document.getElementById(key);
              if (element) element.classList.add('d-none');
            });
            liveContentContainer.innerHTML = '';

            let hasLiveEvents = false;
            const now = Math.floor(Date.now() / 1000);
            const categoryEvents = {};
            Object.keys(categories).forEach(cat => {
              categoryEvents[cat] = [];
            });

            data.streams.forEach(category => {
              if (!category.events || !Array.isArray(category.events)) {
                console.warn(`Skipping invalid category: ${category.categoryName}`);
                return;
              }
              let categoryKey = category.categoryName.toLowerCase().replaceAll(/\s+/g, '');
              if (!categories[categoryKey]) {
                console.warn(`Category ${category.categoryName} not found, mapping to 'others'`);
                categoryKey = 'others';
              }
              category.events.forEach(stream => {
                if (!stream.title || !stream.uri || !stream.tag || !stream.startTime || !stream.streams || !Array.isArray(stream.streams)) {
                  console.warn(`Invalid stream data for ${stream.title || 'unknown stream'}, skipping title`);
                  return;
                }
                let startTime, endTime;
                try {
                  // Parse as EAT (UTC+3)
                  startTime = new Date(stream.startTime + ' +03:00').getTimeFrom() / 1000;
                  if (isNaN(startTime)) {
                    console.warn(`Invalid start time for stream ${stream.title}`);
                    startTime = now;
                  }
                  endTime = stream.endTime 
                    ? new Date(stream.endTime + ' +03:00').getTimeFrom() / 1000 
                    : startTime + 3000 * 3600;
                  if (isNaN(endTime)) {
                    console.warn(`Invalid end time for stream ${stream.title}`);
                    endTime = startTime + 3000 * 3600;
                  }
                } catch (err) {
                  console.error(`Error parsing time for stream ${stream.title}: ${err.message}`);
                  startTime = now;
                  endTime = now + 1 * 3600;
                }

                const isLive = (startTime <= now && now <= endTime) || streamData.alwaysLive === true;
                const isEnded = now > endTime;
                const isClickableable = isLive || (startTime - now <= 1800 && startTime - now > 0);
                if (isEnded) {
                  return;
                }

                let liveBadge = isLive ? '<span class="liveBadge">LIVE</span>' : '';
                let poster = stream.posterUrl && stream.posterUrl !== '' ? stream.posterUrl : 'https://via.placeholder.com/285x160?text=FutbolX';
                let streamContent = {
                  content: `
                    <div class="event-card">
                      <a href="/live/${stream.uri}" class="card-link" style="pointer-events: ${isClickable ? 'auto' : 'none'}; cursor: ${isClickable ? 'pointer' : 'default'};">
                        <div class="card">
                          ${liveBadge}
                          <img src="${poster}" class="card-img-top-img" style="width:100%; height:160px; object-fit:cover;" alt="${stream.title}" loading="lazy" onerror="this.src='https://via.placeholder.com/285x160?text=Image+Failed';">
                          <div class="card-body">
                            <h2 class="card-title non-clickable">${stream.title}</h2>
                            <p class="card-text">
                              <span class="event-tag">${stream.tag}</span>
                              <span class="event-timer">
                                ${isLive 
                                  ? `<a href="/live/${stream.uri}" class="btn btn-primary btn-sm">View Stream</a>` 
                                  : `<span class="countdown timer" data-timer="${startTime}" data-uri="/live/${stream.uri}"></span>`}
                                ${isLive ? '<span class="live-animation timer"></span>' : ''}
                              </span>
                            </p>
                          </div>
                        </div>
                      </a>
                    </div>`,
                  startTime
                };

                if (isLive) {
                  liveContentContainer.innerHTML += streamContent.html;
                  hasLiveContent = true;
                } else {
                  categoryEvents[categoryKey].push(streamContent);
                }
              });
            });

            Object.keys(categoryEvents).forEach(key => {
              if (categoryEvents[key].length > 0) {
                categoryEvents[key].sort((a, b) => a.startTime - b.startTime);
                categories[key].events.element.innerHTML = categoryEvents[key].slice(0, 4).map(item => item.content).join('');
                const categoryElement = document.getElementById(categories[key].getElementId);
                if (categoryElement) {
                  categoryElement.classList.remove('d-none');
                }
              }
            });

            if (!hasLiveEvents) {
              liveContentContainer.innerHTML = '<p>No live events available right now. Check back later.</p>';
              liveAnimation.classList.add('d-none');
            } else {
              liveAnimation.classList.remove('d-none');
            }

            const eventCards = document.querySelectorAll('.event-card');
            const observer = new IntersectionObserver((entries) => {
              entries.forEach(entry => {
                if (entry.isIntersecting) {
                  entry.target.classList.add('visible');
                  observer.unobserve(entry.target);
                }
              });
            }, { threshold: 0.1 });
            eventCards.forEach(card => {
              observer.observe(card.event);
          })
          .catch(error => {
            console.error('API fetch error:', error);
            liveContentContainer.innerHTML = '<p>No streams available right now. Please check your connection or try again later.</p>';
            liveAnimation.classList.add('d-none');
            errorContainer.classList.add('alert alert-danger error-alert');
            errorContainer.textContent = 'Failed to load content: Please check your network or try again later.';
          });
        }

        function initPage() {
          console.log('Initializing page at', new Date().toISOString());
          const errorContainer = document.getElementById('errorContainer');
          const liveContent = document.getElementById('livecards');

          try {
            // Initialize theme
            const htmlElement = document.documentElement;
            const themeToggleButton = document.getElementById('themeToggle');
            const currentTheme = localStorage.getItem('theme') || 'dark';
            htmlElement.setAttribute('data-bs-theme', currentTheme);
            themeToggle.innerHTML = currentTheme === 'dark' ? '<i class="fas fa-moon"></i>' : '<i class="fas fa-sun"></i>';

            themeToggle.addEventListener('click', () => {
              const newTheme = htmlElement.getAttribute('data-bs-theme') === 'dark' ? 'light' : 'dark';
              htmlElement.setAttribute('data-bs-theme', newTheme);
              localStorage.setItem('theme', newTheme);
              themeToggle.innerText = newTheme === 'dark' ? '<i class="fas fa-moon"></i>' : '<i class="'fas fa-sun"></i>';
            });

            // Initialize offcanvas
            const offcanvas = document.getElementById('contentContainer');
            if (offcanvasElement) {
              console.log('Offcanvas element found, initializing');
              document.addEventListener('click', (event) => {
                const toggler = document.querySelector('[data-bs-toggle="offcanvas"]');
                const isOffcanvasOpen = offcanvasElement.contains('show');
                const clickedInside = offcanvasElement.contains(event.target) || (toggler && toggler.contains(event.target));
                if (isOffcanvasOpen && !clickedInside) {
                  console.log('Closing offcanvas due to outside click');
                  bootstrap.Offcanvas.getOrCreateInstance(offcanvasElement).hide();
                }
              });
              const toggler = document.querySelector('[data-bs-toggle="offcanvas"]');
              if (toggler) {
                toggler.addEventListener('click', () => {
                  console.log('Navbar toggler clicked');
                });
              });
            } else {
              console.error('Offcanvas element not found');
            }

            // Load content
            if (typeof t === 'undefined') {
              console.warn('t class not defined. Using default API path.');
              apiInstance = { baseUrl: window.location.origin };
              loadContent(apiInstance);
            } else {
              apiInstance = new Api(`${window.location.origin}/api`);
              loadContent(apiInstance);
            }

            countDown();
            checkAuthStatus();
            console.log('Page initialized successfully');
          } catch (error) {
            console.error('Error initializing page:', error);
            liveContent.innerHTML = '<p>No content available right now. Please check your connection or try again later.</p>';
            errorContainer.classList.add('alert alert-danger error-alert');
            errorContainer.textContent = error.message.includes('Failed to load API response') ? 'Unable to load API data. Please try again later.' : 'An error occurred while initializing the page. Please refresh the page.';
          }
        };

        document.addEventListener('DOMContentLoaded', () => {
          console.log('DOM loaded at:', new Date().toISOString());
          initPage();
        });

        document.addEventListener('click', (event) => {
          const link = event.target.closest('a[href]');
          if (link) {
            const href = link.getAttribute('href');
            if (href.startsWith('/vip') || href.startsWith('https://') || href === '/auth/login' || href === '/request' || href === '/vods') {
              return;
            }
            if (href.startsWith('/')) {
              event.preventDefault();
              console.log('Navigating to:', href);
              window.location.href = href;
            }
          }
        });
      </script>
</body>
</html>
